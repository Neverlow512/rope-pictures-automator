# Rope Faceswap Automator

## Purpose

This Python script (`rope_automator.py`) provides a way to automate batch faceswapping of images using the Rope library ([https://github.com/Hillobar/Rope](https://github.com/Hillobar/Rope)). It operates headlessly (without launching the Rope GUI) by directly interacting with Rope's internal classes.

## Features

*   **Batch Processing:** Processes all compatible images found in a specified input directory.
*   **Headless Operation:** Runs without needing the Rope GUI, suitable for automation.
*   **Uses Saved Settings:** Reads faceswapping parameters (thresholds, masks, restorers, etc.) directly from your `saved_parameters.json` file.
*   **Single Source Face:** Uses one specified image as the source face for all swaps.
*   **Sequential Processing:** Processes images one by one, waiting for each swap to complete before starting the next.
*   **Conditional Saving:** Only saves an image to the output folder if a faceswap actually resulted in a modified image. Images where no face was detected/matched are skipped.

## Prerequisites

1.  **Python:** You need Python installed (matching the version Rope requires, usually 3.10 or similar).
2.  **Rope Library:** You must have successfully downloaded or cloned the Rope repository and installed all its dependencies.
3.  **Dependencies Installed:** Ensure all libraries required by Rope (e.g., `onnxruntime-gpu`, `torch`, `torchvision`, `numpy`, `opencv-python`, `scikit-image`) are installed within Rope's virtual environment.
4.  **Virtual Environment:** It's **highly recommended** (and assumed by this script's primary usage method) that Rope is set up within a Python virtual environment (e.g., `venv`).
5.  **`saved_parameters.json`:** You need a valid `saved_parameters.json` file generated by the Rope GUI, containing the settings you want to use for the automated swaps.
6.  **Source Face Image:** A clear image file containing the single face you want to swap onto other images.
7.  **Target Images:** A folder containing the images you want the source face swapped onto.
8.  **(Optional but Recommended) CUDA Setup:** For GPU acceleration (much faster), ensure you have a compatible NVIDIA GPU, the correct CUDA Toolkit installed, and cuDNN configured. `onnxruntime-gpu` must be installed.

## Configuration

Before running the script, you **MUST** edit the following path variables near the top of `rope_automator.py`:

```python
# --- Paths (Provided by you) ---
face_image_path = r"F:\Faceswap\Rope\Faces\chloe_face.jpg" # <--- SET FULL PATH to your source face image
input_directory = r"F:\Faceswap\Rope\Pictures"            # <--- SET FULL PATH to your input images folder
output_directory = r"F:\Faceswap\Rope\Output"             # <--- SET FULL PATH to where results should be saved
saved_parameters_path = r"F:\Faceswap\Rope\saved_parameters.json" # <--- SET FULL PATH to your Rope settings file
```

Replace the example paths with the full, correct paths on your system.

Use raw strings (`r"..."`) on Windows to handle backslashes correctly.

## Usage

### Open Terminal

Open Command Prompt, PowerShell, or your preferred terminal.

### Navigate to Rope Directory

Change directory to where you have the Rope project and this script:

```sh
cd F:\Faceswap\Rope
```

*(Replace `F:\Faceswap\Rope` with your actual Rope project path.)*

### Activate Virtual Environment

Activate the Python virtual environment you created for Rope. The command might vary slightly:

#### Command Prompt:
```sh
.\venv\Scripts\activate.bat
```

#### PowerShell:
```sh
.\venv\Scripts\Activate.ps1  
```
(*You might need to adjust execution policy first.*)

#### Git Bash / Linux / macOS:
```sh
source venv/bin/activate
```
(*Replace `venv` if your virtual environment folder has a different name.*)

You should see the environment name (e.g., `(venv)`) appear at the beginning of your terminal prompt.

### Run the Script

Execute the Python script using the activated environment's Python interpreter:

```sh
python rope_automator.py
```

### Monitor Output

The script will print progress information, including which file it's processing, success messages, warnings if no swap occurred, and any errors encountered.

### Check Results

Processed images (where a swap was performed) will be saved in the `output_directory` you configured.

## How it Works

1. Instead of launching `rope.py` (which starts the GUI), this script imports Rope's core `Models` and `VideoManager` classes directly.
2. It initializes these classes.
3. It loads the settings from your `saved_parameters.json` and applies them to the `VideoManager`.
4. It loads the source face image, detects its landmarks, and calculates its facial embedding using Rope's models.
5. It prepares the `VideoManager` by storing this source embedding in a way that mimics selecting it in the GUI.
6. It loops through each image in the input directory.
7. For each image, it calls the `VideoManager`'s internal `swap_video` function.
8. The script checks if the returned image data is different from the original input image data using `numpy.array_equal`.
9. If a change occurred (a swap was performed), the resulting image is saved to the output directory.
10. After processing all images, it attempts to clean up GPU resources.

## Troubleshooting / Notes

* **`ModuleNotFoundError`**: Ensure you have activated the correct virtual environment before running the script and that all Rope dependencies are installed in that environment.
* **CUDA Errors / Slow Performance**: If you intended to use the GPU, ensure `onnxruntime-gpu` is installed (not `onnxruntime`), CUDA/cuDNN are correctly set up, and your GPU drivers are up to date.
* **No face landmarks detected in the source image**: Ensure the source image contains a clear, detectable face.
* **Images Skipped (No Swap Performed)**:
  * No face was detected in the target image.
  * A face was detected, but its similarity to the source face embedding was below the `ThresholdSlider` value set in your `saved_parameters.json`.
  * Other parameters (like masking) might have resulted in the final image being identical to the original.
* **Memory Errors (CUDA)**: Try reducing the number of images processed at once or ensure other GPU-intensive applications are closed.
* **Parameter Tuning**: The quality of the swaps heavily depends on the settings in `saved_parameters.json`. Use the Rope GUI to experiment and find optimal settings before using this automation script.

## License

### MIT License

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

